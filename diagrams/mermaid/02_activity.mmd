flowchart TD
    A[User Opens Application] --> B[Load Dashboard]
    B --> C[User Enters Directory Path]
    C --> D[User Clicks Start Scan]
    D --> E[Validate Directory Path]
    E --> F{Directory Valid?}
    F -->|No| G[Show Error Message]
    G --> C
    F -->|Yes| H[Create Scan Session]
    H --> I[Initialize File Service]
    I --> J[Start Background Scan Process]
    J --> K[Update Status to Running]
    K --> L[Scan Directory Recursively]
    L --> M[Process Each File]
    M --> N{File Already Exists?}
    N -->|Yes| O[Update scan_session_id]
    N -->|No| P[Calculate File Hash]
    O --> Q[Classify File Type]
    P --> Q
    Q --> R[Extract File Metadata]
    R --> S[Store/Update File in Database]
    S --> T[Update Progress 0-50%]
    T --> U{More Files?}
    U -->|Yes| M
    U -->|No| V[Send Progress Update 50%]
    V --> W[Run Duplicate Detection]
    W --> X[Compare File Hashes]
    X --> Y[Group Similar Files]
    Y --> Z[Calculate Similarity Scores]
    Z --> AA[Create Duplicate Groups]
    AA --> BB[Update Progress 75%]
    BB --> CC[Update Scan Status to Completed]
    CC --> DD[Update Progress 100%]
    DD --> EE[Send WebSocket Update]
    EE --> FF[Display Results in UI]
    FF --> GG[User Reviews Duplicates]
    GG --> HH{User Wants Cleanup?}
    HH -->|No| II[End Process]
    HH -->|Yes| JJ[User Selects Cleanup Rules]
    JJ --> KK[Preview Cleanup Actions]
    KK --> LL{User Confirms?}
    LL -->|No| JJ
    LL -->|Yes| MM[Execute Cleanup]
    MM --> NN[Move Files to Backup]
    NN --> OO[Delete Duplicate Files]
    OO --> PP[Update Database]
    PP --> QQ[Send Cleanup Complete Notification]
    QQ --> RR[Refresh UI with Results]
    RR --> II

    %% Scan History Management
    FF --> SS{User Wants to Delete Scan?}
    SS -->|Yes| TT[User Clicks Delete]
    TT --> UU[Show Confirmation Dialog]
    UU --> VV{User Confirms?}
    VV -->|No| FF
    VV -->|Yes| WW[Delete Scan from Database]
    WW --> XX[Delete Associated Files and Duplicates]
    XX --> YY[Refresh Scan History]
    YY --> FF

    FF --> ZZ{User Wants Bulk Delete?}
    ZZ -->|Yes| AAA[Enter Bulk Select Mode]
    AAA --> BBB[User Selects Multiple Scans]
    BBB --> CCC[User Clicks Bulk Delete]
    CCC --> DDD[Show Bulk Confirmation Dialog]
    DDD --> EEE{User Confirms?}
    EEE -->|No| AAA
    EEE -->|Yes| FFF[Delete Multiple Scans]
    FFF --> GGG[Delete All Associated Data]
    GGG --> HHH[Refresh Scan History]
    HHH --> FF

    %% Parallel Processes
    J --> LLL[WebSocket Connection]
    LLL --> MMM[Send Real-time Updates]
    MMM --> NNN{Scan Active?}
    NNN -->|Yes| OOO[Send Progress Update]
    OOO --> MMM
    NNN -->|No| PPP[Close WebSocket]

    %% Error Handling
    J --> QQQ{Error Occurs?}
    QQQ -->|Yes| RRR[Log Error]
    RRR --> SSS[Update Scan Status to Failed]
    SSS --> TTT[Send Error Notification]
    TTT --> UUU[Display Error in UI]
    UUU --> II
